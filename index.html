<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¾ªç’°è³½ç³»çµ±</title>

<style>
body{
  font-family: Arial;
  margin:0;
  background:#111;
  color:#fff;
}

.top{
  padding:10px;
  background:#222;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

button{
  padding:8px 14px;
  border:0;
  border-radius:6px;
  background:#3a7afe;
  color:#fff;
  font-size:14px;
}

input{
  padding:6px;
  font-size:16px;
}

.container{
  display:flex;
  flex-wrap:wrap;
  gap:20px;
  padding:10px;
}

table{
  border-collapse: collapse;
  background:#222;
}

td,th{
  border:1px solid #444;
  padding:6px;
  text-align:center;
}

.rankTable td{
  font-size:18px;
}

.big .rankTable td{
  font-size:32px;
  padding:14px;
}

.big h2{font-size:40px}

@media(max-width:800px){
  .container{flex-direction:column;}
}
</style>
</head>
<body>

<div class="top">
<input id="nameInput" placeholder="è¼¸å…¥åå­—åŠ å…¥">
<button onclick="join()">åŠ å…¥ç©å®¶</button>
<button onclick="reset()">é‡ç½®</button>
<button onclick="toggleProjector()">æŠ•å½±æ¨¡å¼</button>
</div>

<div id="qr"></div>

<div class="container">

<div>
<h2>å°æˆ°</h2>
<table id="scoreTable"></table>
</div>

<div>
<h2>æ’å</h2>
<table class="rankTable">
<thead>
<tr>
<th>#</th><th>ç©å®¶</th><th>å‹</th><th>æ•—</th><th>å°åˆ†</th>
</tr>
</thead>
<tbody id="rankBody"></tbody>
</table>
</div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<!-- QR -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
// ğŸ”´ è²¼ä½ çš„config
const firebaseConfig = {
  apiKey: "AIzaSyCtXt_zgFXgAaUJxq-WFPJvkAQ5agegDok",
  authDomain: "gscrl-ranking-system.firebaseapp.com",
  databaseURL: "https://gscrl-ranking-system-default-rtdb.firebaseio.com",
  projectId: "gscrl-ranking-system",
  storageBucket: "gscrl-ranking-system.firebasestorage.app",
  messagingSenderId: "402703359156",
  appId: "1:402703359156:web:ac3cb76bbb0288f5cc4be1"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let players=[];
let stats={};

// QR code
new QRCode(document.getElementById("qr"), location.href);

// åŠ å…¥
function join(){
  const name=document.getElementById("nameInput").value.trim();
  if(!name) return;

  db.ref("tournament/players").once("value",snap=>{
    let arr=snap.val()||[];
    if(arr.includes(name)) return;

    if(arr.length>=8){
      alert("å·²æ»¿8äºº");
      return;
    }

    arr.push(name);
    db.ref("tournament/players").set(arr);
    document.getElementById("nameInput").value="";
  });
}

// é‡ç½®
function reset(){
  if(!confirm("é‡ç½®?")) return;
  db.ref("tournament").set({});
}

// ç›£è½ç©å®¶
db.ref("tournament/players").on("value",snap=>{
  players=snap.val()||[];
  build();
});

// å»ºç«‹è¡¨
function build(){
  const table=document.getElementById("scoreTable");
  table.innerHTML="";

  if(players.length===0) return;

  let header="<tr><th></th>";
  players.forEach(p=> header+=`<th>${p}</th>`);
  header+="</tr>";
  table.innerHTML+=header;

  players.forEach((p1,i)=>{
    let row=`<tr><th>${p1}</th>`;
    players.forEach((p2,j)=>{
      if(i===j){
        row+="<td>-</td>";
      }else if(i<j){
        row+=`<td>
        <input placeholder="2:1"
        onchange="save('${p1}','${p2}',this.value)">
        </td>`;
      }else row+="<td></td>";
    });
    row+="</tr>";
    table.innerHTML+=row;
  });

  load();
}

function save(p1,p2,val){
  db.ref(`tournament/scores/${p1}_${p2}`).set(val);
}

// ç›£è½æ¯”åˆ†
function load(){
  db.ref("tournament/scores").on("value",snap=>{
    const data=snap.val()||{};

    document.querySelectorAll("input").forEach(inp=>{
      const row=inp.closest("tr").rowIndex-1;
      const col=inp.parentElement.cellIndex-1;

      if(row<0||col<0) return;

      const p1=players[row];
      const p2=players[col];

      const key=`${p1}_${p2}`;
      if(data[key]) inp.value=data[key];
    });

    calc();
  });
}

function calc(){
  stats={};
  players.forEach(p=>{
    stats[p]={win:0,lose:0,small:0};
  });

  document.querySelectorAll("input").forEach(inp=>{
    const val=inp.value;
    if(!val.includes(":")) return;

    const [a,b]=val.split(":").map(Number);
    if(isNaN(a)||isNaN(b)) return;

    const row=inp.closest("tr").rowIndex-1;
    const col=inp.parentElement.cellIndex-1;

    const p1=players[row];
    const p2=players[col];

    stats[p1].small+=a-b;
    stats[p2].small+=b-a;

    if(a>b){
      stats[p1].win++;
      stats[p2].lose++;
    }else{
      stats[p2].win++;
      stats[p1].lose++;
    }
  });

  render();
}

function render(){
  const arr=players.map(p=>({name:p,...stats[p]}));

  arr.sort((a,b)=>{
    if(b.win!==a.win) return b.win-a.win;
    return b.small-a.small;
  });

  const body=document.getElementById("rankBody");
  body.innerHTML="";

  arr.forEach((p,i)=>{
    body.innerHTML+=`
    <tr>
    <td>${i+1}</td>
    <td>${p.name}</td>
    <td>${p.win}</td>
    <td>${p.lose}</td>
    <td>${p.small}</td>
    </tr>`;
  });
}

// æŠ•å½±æ¨¡å¼
function toggleProjector(){
  document.body.classList.toggle("big");
}
</script>
</body>
</html>
